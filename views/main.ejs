<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>TODOリスト</title>
        <%-include('./header')%>
        <script type="text/javascript" src="/javascripts/main.js"></script>
        <link rel="stylesheet" href="/stylesheets/main.css">
    </head>
    <body>
    <div id="wrap">
        <article>
        <h1>TODOリスト</h1>
        <p><%=message%></p>
        <form action="/main/new" method="post">
            <input type="text" name="content" placeholder="日本語と英数字のみ対応" required>
            <select name="attribute">
                <option value="m" selected>しないといけないこと</option>
                <option value="w">やりたいこと</option>
                <option value="e">そのうちすること</option>
            </select>
            <button type="submit">送信</button>
        </form>
        
        <div id="main">
        <section>
        <div class="must">
            <h3>しないといけないこと</h3>
            <div class="list">
            <% for(let i = 0;i < m[0].length;i++){ %>
                <input class="list-checkbox" type="checkbox" value=<%= m[1][i]%>><p class="list-content m" value=<%= m[1][i]%>><%= m[0][i] %></p>
            <% } %>
            </div>
        </div>
        </section>

        <section>
        <div class="want">
            <h3>やりたいこと</h3>
            <div class="list">
            <% for(let i = 0;i < w[0].length;i++){ %>
                <input class="list-checkbox" type="checkbox" value=<%= w[1][i]%>><p class="list-content w" value=<%= w[1][i]%>><%= w[0][i] %></p>
            <% } %>
            </div>
        </div>
        </section>

        <section>
        <div class="eventually">
            <h3>そのうちすること</h3>
            <div class="list">
            <% for(let i = 0;i < e[0].length;i++){ %>
                <input class="list-checkbox" type="checkbox" value=<%= e[1][i]%>><p class="list-content e" value=<%= e[1][i]%>><%= e[0][i] %></p>
            <% } %>
            </div>
        </div>
        </section>
        </div>
        </article>
    </div>
    </body>
    <script type="text/javascript" src="/javascripts/jquery.js"></script>
    <script type="text/javascript" src="/javascripts/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.ui.touch-punch.min.js"></script>
    <script>
        // jqueryが外部ファイルで読み込まれないため仕方なし
        $(function() {
            let moveVal = '';
            let movecontent = '';
            $('.list-content').draggable({
                containment: "#main",
                revert: true,
                revertDuration: 1,
                stop: function(event,ui){
                    moveVal = $(this)[0].attributes[1].value;
                    movecontent = $(this).text();
                }
            });
            $('.list').droppable({
                accept: '.list-content',
                drop: function(e, ui) {
                    $(ui.helper[0]).css({'display':'none'});
                    $(ui.helper[0]).prev('input').css({'display':'none'});
                    let self = $(this);
                    let attr = self.children("p")[0].classList[1];
                    setTimeout(function(){
                        self.parent().append(`<input class="list-checkbox" type="checkbox" value=${moveVal}><p class="list-content" value=${moveVal}>${movecontent}</p>`);
                    },200);

                    console.log($(ui)[0].helper[0].attributes[1].value);
                    console.log(attr);

                    $.ajax({
                        url:'/main/change',
                        type:'POST',
                        data:{
                            'id': $(ui)[0].helper[0].attributes[1].value,
                            'attr': attr
                        }
                    })
                    .done(data => {
                        console.log(data);
                    })
                    .fail(data => {
                        console.log(data);
                    })
                    .always(data => { 
                    });
                }
            });

            $(document).on('click','.list-checkbox',function(){
                let self = $(this);
                setTimeout(function(){
                    self.css({'display':'none'});
                    self.next('p').css({'display':'none'});
                    $.ajax({
                        url:'/main/end',
                        type:'POST',
                        data:{
                            'id': self.val()
                        }
                    })
                    .done(data => {
                        console.log(data);
                    })
                    .fail(data => {
                        console.log(data);
                    })
                    .always(data => { 

                    });
                },1000);
            });
        });
    </script>
</html>